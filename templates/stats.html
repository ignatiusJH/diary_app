{# ----------------------------------------------
  stats.html
  - 체크리스트(Todo)의 전체/기간별 통계를 보여주는 페이지
  - /stats 라우트에서 렌더링됨 (routers/stats.py)
  ---------------------------------------------- #}
{% extends "base.html" %}
{% block title %}상태 / 통계 - 스텝로그{% endblock %}

{# head 안에 통계 페이지 전용 CSS를 추가하는 블록 #}
{% block head_style %}
<style>
  .stats-wrap {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .page-header .page-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #3b2f26;
  }

  .page-header {
    font-size: 13px;
    color: #8b6f55;
  }

  /* ===== 상단 기간 필터 블록 전체 ===== */
  .stats-filter-block {
    margin-top: 8px;
    margin-bottom: 20px;
  }

  .stats-filter-title {
    font-size: 15px;
    font-weight: 600;
    color: #3b2f26;
    margin-bottom: 10px;
  }

  .stats-filter-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }

  .stats-filter-dates {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .stats-date-input {
    min-width: 210px;
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid #d5c1a7;
    background: #fbf3e7;
    color: #3b2f26;
    font-size: 13px;
    box-sizing: border-box;
    text-align: center;
  }

  .stats-date-input::-webkit-calendar-picker-indicator {
    filter: invert(0.3); /* 날짜 선택 아이콘 색 살짝 조정 */
  }

  .stats-tilde {
    font-size: 14px;
    color: #8b6f55;
  }

  .stats-filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .stats-filter-note {
    font-size: 12px;
    color: #8b6f55;
    margin-top: 6px;
  }

  /* ===== 공통 버튼 (통계 페이지 전용) ===== */
  .btn-stat-primary,
  .btn-stat-ghost {
    font-size: 13px;
    padding: 7px 18px;
    border-radius: 999px;
    border: 1px solid #c86a21;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    white-space: nowrap;
  }

  .btn-stat-primary {
    background: #c86a21;
    color: #fff7ec;
  }

  .btn-stat-primary:hover {
    background: #a85416;
    border-color: #a85416;
  }

  .btn-stat-ghost {
    background: transparent;
    color: #a85416;
    border-color: #e2d2b8;
  }

  .btn-stat-ghost:hover {
    background: #f7ecde;
    border-color: #d5c1a7;
  }

  /* ===== 섹션 라벨 (소제목) ===== */
  .section-label {
    margin-top: 20px;
    margin-bottom: 8px;
    font-size: 16px;
    font-weight: 600;
    color: #3b2f26;
  }

  /* ===== 통계 카드 그리드 ===== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
  }

  .stat-card {
    background: #f7ecde;
    border-radius: 10px;
    border: 1px solid #e2d2b8;
    padding: 16px 18px;
    color: #3b2f26;
  }

  .stat-head {
    font-size: 13px;
    color: #8b6f55;
    margin-bottom: 4px;
  }

  .stat-value {
    font-size: 26px;
    font-weight: 700;
    margin-bottom: 4px;
    color: #3b2f26;
  }

  .stat-sub {
    font-size: 12px;
    color: #7a5b3a;
    line-height: 1.5;
  }

  .stats-idea-card {
    margin-top: 16px;
  }

  /* ===== 오른쪽 아래 고정 백업/복원 버튼 컨테이너 ===== */
  .backup-restore-container {
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 50;
    display: flex;
    gap: 8px;
  }

  /* ===== 모바일 레이아웃 조정 ===== */
  @media (max-width: 768px) {
    .stats-filter-form {
      align-items: stretch;
      margin-left: 0;
      margin-right: 30px;
    }

    .stats-filter-dates {
      flex-direction: column;
      align-items: stretch;
      gap: 4px;
    }

    .stats-date-input {
      width: 100%;
      min-width: 0;
    }

    .stats-tilde {
      text-align: center;
      width: 100%;
    }

    .stats-filter-buttons {
      justify-content: flex-start;
      gap: 8px;
    }
  }
</style>
{% endblock %}

{# 실제 페이지 내용 영역 #}
{% block content %}
<div class="stats-wrap">
  <!-- 상단 제목 -->
  <div class="page-header">
    <div class="page-title">상태 / 통계</div>
  </div>

  <!-- ============================
       1) 체크리스트 기간 필터
       - stats.py 에서 start / end 를 쿼리로 받아서 필터링
       ============================ -->
  <div class="stats-filter-block">
    <div class="stats-filter-title">체크리스트 기간 필터</div>

    <form method="get" action="/stats" class="stats-filter-form">
      <div class="stats-filter-dates">
        <input
          type="date"
          name="start"
          value="{{ start or '' }}"
          class="stats-date-input"
        >
        <span class="stats-tilde">~</span>
        <input
          type="date"
          name="end"
          value="{{ end or '' }}"
          class="stats-date-input"
        >
      </div>

      <div class="stats-filter-buttons">
        <button type="submit" class="btn-stat-primary">기간 적용</button>
        <a href="/stats" class="btn-stat-ghost">전체 기간으로 초기화</a>
      </div>
    </form>

    {# start / end 가 None 일 수도 있으니, 표시용은 조금 친절하게 #}
    <p class="stats-filter-note">
      선택된 기간:
      {% if start and end %}
        {{ start }} ~ {{ end }}
      {% elif start and not end %}
        {{ start }} ~ (마지막 날짜까지)
      {% elif not start and end %}
        (처음 날짜부터) ~ {{ end }}
      {% else %}
        전체 기간
      {% endif %}
    </p>
  </div>

  <!-- ============================
       2) 체크리스트 (전체 기간 기준)
       - overall_* 값 사용
       ============================ -->
  <div class="section-label">체크리스트 (전체 기간)</div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-head">전체 항목 수</div>
      <div class="stat-value">{{ overall_total }}</div>
      <div class="stat-sub">
        진행 중(pending) / 완료 / 포기를 모두 합한 개수입니다.
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-head">완료</div>
      <div class="stat-value">{{ overall_done }}</div>
      <div class="stat-sub">
        완료율: {{ overall_done_rate }} %
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-head">포기</div>
      <div class="stat-value">{{ overall_giveup }}</div>
      <div class="stat-sub">
        포기율: {{ overall_gaveup_rate }} %
      </div>
    </div>
  </div>

  <!-- ============================
       3) 체크리스트 (선택 기간 기준)
       - range_* 값 사용
       ============================ -->
  <div class="section-label">체크리스트 (선택 기간)</div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-head">선택 기간 항목 수</div>
      <div class="stat-value">{{ range_total }}</div>
      <div class="stat-sub">
        선택한 기간 안에서 생성된 전체 항목 수입니다.<br>
        (진행 중 / 완료 / 포기 포함)
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-head">완료</div>
      <div class="stat-value">{{ range_done }}</div>
      <div class="stat-sub">
        완료율: {{ range_done_rate }} %
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-head">포기</div>
      <div class="stat-value">{{ range_giveup }}</div>
      <div class="stat-sub">
        포기율: {{ range_gaveup_rate }} %
      </div>
    </div>
  </div>

  <!-- ============================
       4) 향후 확장 아이디어 (메모용)
       ============================ -->
  <div class="section-label">향후 확장 아이디어</div>
  <div class="stat-card stats-idea-card">
    <div class="stat-head">예: 월별 추이, 태그 기반 통계 등</div>
    <div class="stat-sub">
      - 월별 체크리스트 생성 / 완료 / 포기 추이<br>
      - 태그(공부, 운동, 지출 등)별 비중<br>
      - 주간 / 월간 달성률 트렌드<br>
      이런 것들은 나중에 차트(Bar, Line 등)로 확장해서 붙일 수 있다.
    </div>
  </div>
</div>

<!-- ============================
     5) 오른쪽 아래 고정 DB 백업/복원 버튼
     ============================ -->
<div class="backup-restore-container">
  <!-- DB 파일 다운로드 -->
  <a href="/backup/db" class="btn-stat-primary">
    DB 백업 다운로드
  </a>

  <!-- DB 복원 업로드 -->
  <form
    method="post"
    action="/restore/db"
    enctype="multipart/form-data"
  >
    <input
      type="file"
      name="file"
      accept=".zip,.db"
      style="display: none;"
      id="dbfile"
      onchange="this.form.submit()"
    />
    <button
      type="button"
      class="btn-stat-primary"
      onclick="document.getElementById('dbfile').click()"
    >
      DB 복원
    </button>
  </form>
</div>
{% endblock %}
