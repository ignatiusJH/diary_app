{% extends "base.html" %}

{% block title %}체크리스트 - 스텝로그{% endblock %}

{% block head_style %}
<style>
  /* ===============================
   * 포커스 스타일 공통
   * - 버튼/입력창 선택 시 연한 오렌지 테두리
   * =============================== */
  button:focus,
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    box-shadow: 0 0 0 1px rgba(200, 106, 33, 0.35); /* 연한 오렌지 포커스 링 */
  }

  /* 제목/인라인 입력 공통 폰트 크기 */
  .schedule-title,
  .history-title,
  .todo-edit-inline .todo-input {
    font-size: 14px;
  }

  /* 페이지 전체 래퍼 */
  .todo-wrap {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* 페이지 헤더 (체크리스트 제목) */
  .page-header .page-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #3b2f26; /* 진한 브라운 */
  }

  /* ===============================
   * 전체 레이아웃: 좌(4), 우(6)
   * =============================== */
  .section-grid {
    display: flex;
    flex-direction: column; /* 기본: 모바일에서 위아래 */
    gap: 16px;
  }

  @media (min-width: 1024px) {
    .section-grid {
      flex-direction: row;       /* 데스크탑: 좌우로 나누기 */
      align-items: flex-start;
    }

    .section-left {
      flex: 4;                   /* 왼쪽: 새 항목 + 히스토리 */
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-right {
      flex: 6;                   /* 오른쪽: 진행중 리스트 */
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
  }

  .section-left,
  .section-right {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* ===============================
   * 카드 공통 스타일 (desert 톤)
   * =============================== */
  .card {
    background: #f7ecde;
    border-radius: 10px;
    border: 1px solid #e2d2b8;
    padding: 16px 20px;
    color: #3b2f26;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 12px;
    gap: 8px;
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
  }

  .card-meta {
    font-size: 12px;
    color: #8b6f55;
  }

  /* ===============================
   * 텍스트 인풋 (제목 수정/추가)
   * =============================== */
  .todo-input {
    width: 100%;
    padding: 9px 10px;
    border-radius: 6px;
    border: 1px solid #d5c1a7;
    background: #fbf3e7;
    color: #3b2f26;
    font-size: 14px;
    box-sizing: border-box;
  }

  .todo-input::placeholder {
    color: #b59a7f;
  }

  /* ===============================
   * 버튼 공통
   * =============================== */

  /* 오렌지 기본 버튼 (추가, 조회, 등) */
  .btn-primary {
    padding: 8px 18px;
    border-radius: 999px;
    border: 1px solid #c86a21;
    background: #c86a21;
    color: #fff7ec;
    font-size: 13px;
    cursor: pointer;
  }

  .btn-primary:hover {
    background: #a85416;
    border-color: #a85416;
  }

  /* 테두리만 있는 버튼 (조회, 토글 등) */
  .btn-outline {
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid #d5c1a7;
    background: #f7ecde;
    color: #8b6f55;
    font-size: 12px;
    cursor: pointer;
  }

  .btn-outline:hover {
    background: #f2e2cf;
    color: #5b4332;
  }

  /* pill 형태 버튼 (진행중 / 히스토리 공용으로 사용) */
  .todo-pill {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #d5c1a7;
    background: #f7ecde;
    color: #5b4332;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    white-space: nowrap;
  }

  .todo-pill:hover {
    background: #c86a21;
    border-color: #c86a21;
    color: #fff7ec;
  }

  /* ===============================
   * 새 항목 추가 카드
   * =============================== */

  /* 입력 / 버튼 세로 정렬 */
  .todo-new-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* 추가 버튼을 오른쪽으로 붙이기 */
  .todo-new-form .btn-primary {
    align-self: flex-end;
  }

  /* ===============================
   * 진행 중 리스트
   * =============================== */

  .todo-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* 각 todo 카드 (드래그 가능) */
  .todo-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 8px;
    background: #fbf3e7;
    border: 1px solid #e2d2b8;
    cursor: grab;
  }

  .todo-item:active {
    cursor: grabbing;
  }

  /* 드래그 중인 항목 강조 */
  .todo-item.dragging {
    opacity: 0.7;
    border-color: #c86a21;
  }

  /* 왼쪽(제목, 인풋) 영역 */
  .todo-left {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  /* 제목 인라인 수정 폼 */
  .todo-edit-inline {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .todo-edit-inline .todo-input {
    flex: 1;
  }

  /* 오른쪽 액션 버튼 영역 (완료/포기/삭제) */
  .todo-actions {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 6px;
    margin-left: 8px;
  }

  .todo-actions form {
    margin: 0;
  }

  .todo-empty {
    font-size: 13px;
    color: #a58a6d;
  }

  /* 작은 화면에서 레이아웃 깨지지 않게: 위/아래 정렬 */
  @media (max-width: 900px) {
    .todo-item {
      flex-direction: column;
      align-items: stretch;
    }

    .todo-actions {
      justify-content: flex-end;
    }
  }

  /* ===============================
   * 완료 / 포기 내역 카드
   * =============================== */

  .history-header {
    cursor: pointer; /* 헤더 전체를 클릭해서 열기/닫기 */
  }

  .history-toggle-btn {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #d5c1a7;
    background: #f7ecde;
    color: #8b6f55;
    font-size: 11px;
    cursor: pointer;
  }

  .history-toggle-btn:hover {
    background: #f2e2cf;
    color: #5b4332;
  }

  /* JS 에서 block / none 으로 토글 */
  .history-body {
    margin-top: 8px;
    display: none;
  }

  .history-filter {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 12px;
  }

  .history-filter-row label {
    font-size: 12px;
    color: #8b6f55;
    margin-bottom: 4px;
    display: block;
  }

  .history-filter-range {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .history-filter input[type="date"] {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #d5c1a7;
    background: #fbf3e7;
    color: #3b2f26;
    font-size: 12px;
  }

  /* 기간 검색용 date input 의 달력 아이콘은 기본 스타일 유지 */
  .history-filter input[type="date"]::-webkit-calendar-picker-indicator {
    filter: none;
  }

  .history-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .history-item {
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #e2d2b8;
    background: #fbf3e7;
  }

  .history-title {
    font-size: 13px;
    color: #3b2f26;
    margin-bottom: 2px;
  }

  .history-meta {
    font-size: 11px;
    color: #8b6f55;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: space-between;
  }

  /* 상태/날짜 묶음과 버튼 영역 분리 */
  .history-meta-left {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .history-meta-right {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  /* 상태별 색상: 완료 / 포기 */
  .history-status.done {
    color: #25633c;
  }

  .history-status.giveup {
    color: #9a3412;
  }

  .history-empty {
    font-size: 12px;
    color: #a58a6d;
  }

  .history-status-select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #d5c1a7;
    background: #fbf3e7;
    color: #3b2f26;
    font-size: 12px;
  }

  .history-status-select:focus {
    outline: none;
    border-color: #c86a21;
  }

  /* 완료/포기 내역 페이지네이션 */
  .pagination {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #8b6f55;
    flex-wrap: wrap;
  }

  .page-link {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid #d5c1a7;
    text-decoration: none;
    color: #8b6f55;
    background: #fbf3e7;
  }

  .page-link:hover {
    background: #f2e2cf;
    color: #5b4332;
  }

  .page-link.active {
    border-color: #c86a21;
    color: #c86a21;
    font-weight: 600;
  }

  .page-info {
    color: #8b6f55;
  }
</style>
{% endblock %}

{% block content %}
<div class="todo-wrap">
  <div class="page-header">
    <div class="page-title">체크리스트</div>
  </div>

  <div class="section-grid">
    <!-- =========================
         왼쪽: 새 항목 + 완료/포기 내역
         ========================= -->
    <div class="section-left">
      <!-- 새 항목 추가 카드 -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">새 항목 추가</div>
        </div>

        {# 
          새 pending 항목 생성 폼
          - POST /todos
        #}
        <form method="post"
              action="/todos"
              class="todo-new-form todo-confirm"
              data-action="create"
              id="todo-new-form">
          <input type="text"
                 name="title"
                 placeholder="해야 할 일을 적어 주세요"
                 autocomplete="off"
                 class="todo-input">
          <button type="submit" class="btn-primary">추가</button>
        </form>
      </section>

      <!-- 완료 / 포기 내역 카드 (접었다 펼치는 구조) -->
      <section class="card">
        <div class="card-header history-header" id="history-toggle">
          <div>
            <div class="card-title">완료 / 포기 내역</div>
            <div class="card-meta">
              최근 {{ (history_items|default([], true))|length }}개
            </div>
          </div>
          <button type="button"
                  class="history-toggle-btn"
                  id="history-toggle-btn"
                  aria-expanded="false">
            열기
          </button>
        </div>

        {# 상단 페이지 이동 버튼 (항상 보이게) #}
        {% if history_total_pages > 1 %}
          <div class="pagination">
            {% for p in range(1, history_total_pages + 1) %}
              <a class="page-link {% if p == history_page %}active{% endif %}"
                 href="?history_page={{ p }}{% if history_start %}&start={{ history_start }}{% endif %}{% if history_end %}&end={{ history_end }}{% endif %}{% if history_status %}&history_status={{ history_status }}{% endif %}&open_history=1">
                {{ p }}
              </a>
            {% endfor %}
          </div>
        {% endif %}

        <!-- 실제 내용(필터 + 리스트)은 history-body 안에 있고, JS로 열고 닫음 -->
        <div class="history-body" id="history-body">
          <!-- 기간/상태 검색 -->
          <form method="get" class="history-filter">
            <div class="history-filter-row">
              <label>기간</label>
              <div class="history-filter-range">
                <input type="date"
                       name="start"
                       value="{{ history_start|default('', true) }}">
                <span style="color:#8b6f55;">~</span>
                <input type="date"
                       name="end"
                       value="{{ history_end|default('', true) }}">
                <input type="hidden" name="open_history" value="1">
                <!-- 상태 선택: 전체 / 완료만 / 포기만 -->
                <select name="history_status" class="history-status-select">
                  <option value="all"
                    {% if history_status is not defined or history_status == 'all' %}selected{% endif %}>
                    전체
                  </option>
                  <option value="done"
                    {% if history_status == 'done' %}selected{% endif %}>
                    완료만
                  </option>
                  <option value="giveup"
                    {% if history_status == 'giveup' %}selected{% endif %}>
                    포기만
                  </option>
                </select>
                <button type="submit" class="btn-outline">조회</button>
              </div>
            </div>
          </form>

          {# history_items 가 없을 수도 있으므로 default 처리 #}
          {% set hist_list = history_items|default([], true) %}
          {% if hist_list %}
            <ul class="history-list">
              {% for h in hist_list %}
                <li class="history-item">
                  <div class="history-title">{{ h.title }}</div>
                  <div class="history-meta">
                    <!-- 왼쪽: 날짜 + 상태 -->
                    <div class="history-meta-left">
                      <span class="history-date">{{ h.date }}</span>
                      <span class="history-status
                                   {% if h.status == 'done' %}done{% elif h.status == 'giveup' %}giveup{% endif %}">
                        {% if h.status == "done" %}완료
                        {% elif h.status == "giveup" %}포기
                        {% else %}기타{% endif %}
                      </span>
                    </div>

                    <!-- 오른쪽: 삭제 버튼 -->
                    <div class="history-meta-right">
                      {# 
                        히스토리 항목 삭제
                        - POST /todos/{{ h.id }}/delete
                        - todos.py 의 delete_todo 재사용
                        - 리다이렉트: /todos?open_history=1 (패널 유지)
                      #}
                      <form method="post"
                            action="/todos/{{ h.id }}/delete"
                            class="todo-confirm"
                            data-action="delete">
                        <button type="submit" class="todo-pill">삭제</button>
                      </form>
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="history-empty">완료하거나 포기한 항목이 없습니다.</p>
          {% endif %}

          {# 하단에는 현재 페이지/전체 페이지만 간단히 표시 #}
          {% if history_total_pages and history_total_pages > 1 %}
            <div class="pagination">
              {% set cur = history_page|default(1, true) %}
              {% set total = history_total_pages %}

              <span class="page-info">{{ cur }} / {{ total }} 페이지</span>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <!-- =========================
         오른쪽: 진행 중 리스트
         ========================= -->
    <div class="section-right">
      <section class="card">
        <div class="card-header">
          <div class="card-title">진행 중</div>
          <div class="card-meta">
            진행 중 {{ items|length }}개
          </div>
        </div>

        {% if items %}
          <ul class="todo-list">
            {% for item in items %}
            <li class="todo-item" draggable="true" data-todo-id="{{ item.id }}">
              <div class="todo-left">
                <!-- 제목 인라인 수정 폼 -->
                <form method="post"
                      action="/todos/{{ item.id }}/update"
                      class="todo-edit-inline todo-confirm"
                      data-action="update">
                  <input type="text"
                         name="title"
                         value="{{ item.title }}"
                         autocomplete="off"
                         class="todo-input">
                  <button type="submit" class="todo-pill">수정</button>
                </form>
              </div>

              <!-- 오른쪽 액션 버튼들 (완료/포기/삭제) -->
              <div class="todo-actions">
                <!-- 완료 -->
                <form method="post"
                      action="/todos/{{ item.id }}/done"
                      class="todo-confirm"
                      data-action="done">
                  <button type="submit" class="todo-pill">완료</button>
                </form>

                <!-- 포기 -->
                <form method="post"
                      action="/todos/{{ item.id }}/giveup"
                      class="todo-confirm"
                      data-action="giveup">
                  <button type="submit" class="todo-pill">포기</button>
                </form>

                <!-- 삭제 -->
                <form method="post"
                      action="/todos/{{ item.id }}/delete"
                      class="todo-confirm"
                      data-action="delete">
                  <button type="submit" class="todo-pill">삭제</button>
                </form>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="todo-empty">진행 중인 체크리스트가 없습니다.</p>
        {% endif %}
      </section>
    </div>
  </div>
</div>

<script>
  // ===============================
  // 1) 완료 / 포기 내역 카드 열기/닫기
  //    - 기본: 닫힘
  //    - URL에 open_history=1 이 있으면 열림
  // ===============================
  (function () {
    const historyHeader = document.getElementById("history-toggle");
    const historyBody   = document.getElementById("history-body");
    const historyBtn    = document.getElementById("history-toggle-btn");

    if (!historyHeader || !historyBody || !historyBtn) return;

    // URL 쿼리 파라미터에서 open_history 값을 확인
    const params = new URLSearchParams(window.location.search);
    const openFromUrl = params.get("open_history") === "1";

    // 기본 값: false, ?open_history=1 이면 true
    let open = openFromUrl;

    function updateState() {
      historyBody.style.display = open ? "block" : "none";
      historyBtn.textContent = open ? "닫기" : "열기";
      historyBtn.setAttribute("aria-expanded", open ? "true" : "false");
    }

    // 카드 헤더 전체를 클릭하면 열기/닫기 토글
    historyHeader.addEventListener("click", function () {
      open = !open;
      updateState();
    });

    // 초기 상태 반영
    updateState();
  })();


  // ===============================
  // 2) 공통 confirm 처리
  //    - data-action 에 따라 메시지 분기
  //    - create / update / done / giveup / delete
  // ===============================
  (function () {
    const messages = {
      create: "새 항목을 추가할까요?",
      update: "이 항목을 수정할까요?",
      done:   "이 항목을 '완료' 처리할까요?",
      giveup: "정말 '포기' 처리할까요?",
      delete: "정말 삭제할까요?\n(통계에서도 사라질 수 있어요)"
    };

    document.querySelectorAll(".todo-confirm").forEach(function (form) {
      form.addEventListener("submit", function (e) {
        const action = form.dataset.action || "update";
        const msg = messages[action] || "계속 진행할까요?";
        if (!window.confirm(msg)) {
          e.preventDefault();
        }
      });
    });
  })();

  // ===============================
  // 3) 드래그 & 드롭으로 순서 변경
  //    - /todos/reorder 로 POST
  //    - pending 상태 항목의 order 필드를 재정렬
  // ===============================
  (function () {
    const list = document.querySelector(".todo-list");
    if (!list) return;  // 진행중 항목이 없으면 드래그 기능 없음

    let draggingItem = null;

    // 드래그 시작: 어떤 li 를 끌고 있는지 기록
    list.addEventListener("dragstart", function (e) {
      const item = e.target.closest(".todo-item");
      if (!item) return;
      draggingItem = item;
      item.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", item.dataset.todoId || "");
    });

    // 드래그 종료: 스타일 원상복구
    list.addEventListener("dragend", function () {
      if (draggingItem) {
        draggingItem.classList.remove("dragging");
        draggingItem = null;
      }
    });

    // 드래그 중: 마우스 위치 기준으로 들어갈 위치 계산
    list.addEventListener("dragover", function (e) {
      e.preventDefault();
      const afterElement = getDragAfterElement(list, e.clientY);
      const dragging = document.querySelector(".todo-item.dragging");
      if (!dragging) return;

      if (!afterElement) {
        // 맨 아래로
        list.appendChild(dragging);
      } else {
        // 특정 요소 앞에 삽입
        list.insertBefore(dragging, afterElement);
      }
    });

    // 드롭 시: 현재 순서대로 id 목록을 서버에 저장
    list.addEventListener("drop", function (e) {
      e.preventDefault();
      saveOrder();
    });

    // 현재 마우스 y 위치보다 "바로 아래"에 들어갈 요소 찾기
    function getDragAfterElement(container, y) {
      const items = Array.from(
        container.querySelectorAll(".todo-item:not(.dragging)")
      );

      return items.reduce(
        function (closest, child) {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          // offset < 0 이면 마우스가 child 위쪽에 있다는 뜻
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY, element: null }
      ).element;
    }

    // 정렬된 순서를 서버에 전송
    function saveOrder() {
      const ids = Array.from(list.querySelectorAll(".todo-item"))
        .map(function (li) { return li.dataset.todoId; })
        .filter(Boolean);

      fetch("/todos/reorder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order: ids })
      })
        .then(function (res) {
          if (!res.ok) throw new Error("서버 오류");
          return res.json();
        })
        .catch(function (err) {
          console.error(err);
          alert("순서를 저장하지 못했습니다. 새로고침 후 다시 시도해 주세요.");
        });
    }
  })();
</script>
{% endblock %}
