{% extends "base.html" %}
{% block title %}일정 - 스텝로그{% endblock %}

{# 
  head_style:
  - base.html 에 정의된 head_style 블록을 이 페이지 전용 CSS로 덮어쓰기.
#}
{% block head_style %}
<style>
  /* 전체 일정 페이지 래퍼 */
  .schedule-wrap {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* 페이지 제목(일정) 스타일 */
  .page-header .page-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #3b2f26;
  }

  /* 좌/우(달력+목록 / 에디터) 레이아웃 컨테이너 */
  .section-grid {
    display: flex;
    flex-direction: column;  /* 기본: 모바일에서 세로 배치 */
    gap: 16px;
  }

  @media (min-width: 1024px) {
    /* 데스크탑 이상: 가로 2열 배치 */
    .section-grid {
      flex-direction: row;
      align-items: flex-start;
    }
    .section-left {
      flex: 4;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .section-right {
      flex: 6;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-width: 0;  /* 오른쪽 카드가 너무 넓어지는 것 방지 */
    }
  }

  .section-left,
  .section-right {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* ===== 공통 카드 스타일 (사막톤) ===== */
  .card {
    background: #f7ecde;
    border-radius: 10px;
    border: 1px solid #e2d2b8;
    padding: 18px 22px;
    color: #3b2f26;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 12px;
    gap: 8px;
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
  }

  .card-meta {
    font-size: 12px;
    color: #8b6f55;
  }

  /* ===== 달력 영역 ===== */

  /* 달력 상단 (이전/다음 버튼 + 연/월 셀렉트) */
  .calendar-head {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 8px;
    gap: 10px;
  }

  .calendar-label {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* 이전/다음 달 이동 버튼 */
  .cal-nav-btn {
    border-radius: 999px;
    border: 1px solid #d5c1a7;
    background: #f5e6d4;
    color: #5b4332;
    font-size: 13px;
    padding: 4px 10px;
    cursor: pointer;
  }

  .cal-nav-btn:hover {
    background: #ebd6bf;
  }

  /* 연/월 선택 select 박스 */
  .cal-select {
    border-radius: 999px;
    border: 1px solid #d5c1a7;
    background: #fbf3e7;
    color: #5b4332;
    font-size: 12px;
    padding: 4px 12px;
  }

  /* 달력 테이블 */
  .calendar-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 12px;
    table-layout: fixed;
    color: #5b4332;
  }

  .calendar-table th {
    padding: 6px 0;
    font-weight: 500;
    color: #8b6f55;
  }

  .calendar-table td {
    height: 32px;
    text-align: center;
    vertical-align: middle;
    border-radius: 6px;
    position: relative;
    cursor: pointer;
  }

  .calendar-table td:hover {
    background: #f2e2cf;
  }

  /* 이번 달이 아닌 날짜 */
  .cal-out {
    color: #c3b29a;
  }

  /* 선택된 날 기본 스타일 */
  .cal-selected {
    background: #c86a21;
    color: #fff;
    font-weight: 600;
  }

  /* 오늘 + 선택된 날일 때 텍스트 컬러 조정 */
  .cal-today.cal-selected {
    color: #f3ecdd;
  }

  /* 일정 있는 날 하단 점 표시 */
  .cal-has-schedule::after {
    content: "";
    width: 5px;
    height: 5px;
    border-radius: 999px;
    background: #3da35a;
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
  }

  /* 공휴일 강조 */
  .cal-holiday {
    color: #d17826;
    font-weight: 600;
  }

  /* ===== 왼쪽 : 일정 목록 ===== */

  .schedule-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 13px;
  }

  /* 목록의 각 일정 한 줄 (button) */
  .schedule-item {
    width: 100%;
    text-align: left;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #e2d2b8;
    background: #fbf3e7;
    display: flex;
    flex-direction: column;
    gap: 2px;
    cursor: pointer;
  }

  .schedule-item:hover {
    background: #f2e2cf;
    border-color: #d5c1a7;
  }

  .schedule-title {
    font-size: 13px;
    color: #3b2f26;
  }

  /* 날짜/시간/장소 한 줄 메타 정보 */
  .schedule-meta {
    font-size: 11px;
    color: #8b6f55;
  }

  .schedule-empty {
    font-size: 13px;
    color: #a58a6d;
  }

  .list-meta-count {
    font-size: 12px;
    color: #8b6f55;
  }

  /* ===== 오른쪽 : 일정 입력/수정 에디터 ===== */

  .editor-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .editor-row label {
    display: block;
    margin-bottom: 4px;
    font-size: 13px;
    color: #8b6f55;
  }

  /* 인풋/텍스트에어리어 공통 박스 스타일 */
  .editor-input,
  .editor-textarea {
    width: 100%;
    padding: 9px 10px;
    border-radius: 6px;
    border: 1px solid #d5c1a7;
    background: #fbf3e7;
    color: #3b2f26;
    font-size: 14px;
    box-sizing: border-box;
  }

  .editor-textarea {
    min-height: 240px;
    resize: vertical;
    line-height: 1.5;
    white-space: pre-wrap;
  }

  /* iOS에서 date/time 인풋 모양 통일 및 높이 맞추기 */
  .editor-input[type="date"],
  .editor-input[type="time"] {
    -webkit-appearance: none;   /* 사파리 기본 스타일 제거 */
    appearance: none;
    padding: 9px 10px;
    height: 36px;               /* 높이 고정 */
    line-height: 44px;          /* 세로 가운데 정렬 느낌 */
  }

  .editor-input[type="date"]::-webkit-calendar-picker-indicator,
  .editor-input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(0.5);        /* 아이콘 색 살짝 조정 */
  }

  .editor-bottom {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 4px;
    gap: 8px;
  }

  /* ===== 오렌지 라운드 버튼 (새 일정/저장/삭제) ===== */

  .btn-round {
    padding: 7px 18px;
    border-radius: 999px;
    border: 1px solid transparent;
    font-size: 13px;
    cursor: pointer;
    background: #c86a21;
    border-color: #c86a21;
    color: #fff7ec;
  }

  .btn-round:hover {
    background: #a85416;
    border-color: #a85416;
  }

  /* ===== 달력 hover / 오늘 표시 오버라이드 ===== */

  .calendar-table td:hover {
    background: #f2e2cf;
    color: #4b5563;
  }

  .calendar-table td.cal-today {
    border: 2px solid #e48b47 !important;
    border-radius: 10px !important;
    box-sizing: border-box !important;
    position: relative;
    z-index: 2;
  }

  .calendar-table td.cal-today.cal-selected {
    background: #e48b47 !important;
    color: #ffffff !important;
    border: 2px solid #e48b47 !important;
    border-radius: 10px !important;
  }

  /* ===== 모바일: 일정 작성 영역을 위로 올리기 =====
     - 작은 화면에서 "작성 폼"을 먼저 보고
       아래로 스크롤하면 달력/목록이 나오도록 순서를 뒤집는다.
  */
  @media (max-width: 768px) {
    .section-grid {
      display: flex;
      flex-direction: column;
    }

    .section-left {   /* 달력 + 목록 */
      order: 2;
    }

    .section-right {  /* 오른쪽 입력 패널 */
      order: 1;
    }
  }
  /* ▲ FIX: 원래 여기 .schedule-grid 로 되어 있었는데 실제 HTML은 .section-grid라서
           모바일에서 레이아웃 순서가 안 바뀌는 버그가 있었다. */
</style>
{% endblock %}

{% block content %}
<div class="schedule-wrap">
  <!-- 상단 제목 영역 -->
  <div class="page-header">
    <div class="page-title">일정</div>
  </div>

  <div class="section-grid">
    <!-- ===== 왼쪽 : 달력 + 목록 ===== -->
    <div class="section-left">
      <!-- 달력 카드 -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">달력</div>
        </div>

        <div class="calendar-head">
          <!-- 이전 달 -->
          <button type="button" class="cal-nav-btn" id="cal-prev">‹</button>

          <!-- 연/월 선택 -->
          <div class="calendar-label">
            <select id="year-select" class="cal-select"></select>
            <select id="month-select" class="cal-select">
              <option value="0">1월</option>
              <option value="1">2월</option>
              <option value="2">3월</option>
              <option value="3">4월</option>
              <option value="4">5월</option>
              <option value="5">6월</option>
              <option value="6">7월</option>
              <option value="7">8월</option>
              <option value="8">9월</option>
              <option value="9">10월</option>
              <option value="10">11월</option>
              <option value="11">12월</option>
            </select>
          </div>

          <!-- 다음 달 -->
          <button type="button" class="cal-nav-btn" id="cal-next">›</button>
        </div>

        <!-- 실제 달력 테이블 -->
        <table class="calendar-table">
          <thead>
            <tr>
              <th>일</th>
              <th>월</th>
              <th>화</th>
              <th>수</th>
              <th>목</th>
              <th>금</th>
              <th>토</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
      </section>

      <!-- 일정 목록 카드 -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">목록</div>
          <div class="card-meta">
            <span class="list-meta-count">총 {{ items|length }}개</span>
          </div>
        </div>

        {% if items %}
          <div class="schedule-list">
            {% for item in items %}
              {# time_str / time 둘 다 대응 (옛 구조 호환) #}
              {% set _time = item.time_str if item.time_str is defined else (item.time if item.time is defined else None) %}
              {% set _place = item.place if item.place is defined else None %}
              <button
                type="button"
                class="schedule-item"
                data-id="{{ item.id }}"
                data-date="{{ item.date }}"
                data-time="{{ _time or '' }}"
                data-place="{{ _place or '' }}"
              >
                <div class="schedule-title">{{ item.title }}</div>
                <div class="schedule-meta">
                  {{ item.date }}
                  {% if _time %}
                    · {{ _time }}
                  {% endif %}
                  {% if _place %}
                    · {{ _place }}
                  {% endif %}
                </div>
              </button>
            {% endfor %}
          </div>
        {% else %}
          <p class="schedule-empty">등록된 일정이 없습니다.</p>
        {% endif %}
      </section>
    </div>

    <!-- ===== 오른쪽 : 입력 / 수정 폼 ===== -->
    <div class="section-right">
      <section class="card">
        <div class="card-header">
          <div class="card-title" id="editor-title">일정 작성</div>
          <div class="card-meta">
            <span class="editor-mode-badge" id="editor-mode-badge">새 일정</span>
          </div>
        </div>

        {# 
          일정 작성 / 수정 공용 폼
          - JS 가 "새 일정"일 땐 /schedule/new
          - "수정 모드"일 땐 /schedule/{id}/update 로 action 을 바꿔준다.
        #}
        <form
          id="schedule-editor-form"
          class="editor-form"
          method="post"
          action="/schedule/new"
        >
          <!-- 수정 시에는 이 hidden 에 id 를 넣어서 서버가 어떤 일정인지 알 수 있게 함 -->
          <input type="hidden" id="schedule-id-hidden" name="schedule_id">

          <div class="editor-row">
            <label for="title-input">제목</label>
            <input
              type="text"
              id="title-input"
              name="title"
              class="editor-input"
              required
            >
          </div>

          <div class="editor-row">
            <label for="date-input">날짜</label>
            <input
              type="date"
              id="date-input"
              name="date_str"
              class="editor-input"
              required
            >
          </div>

          <div class="editor-row">
            <label for="time-input">시간 (선택, 24시간)</label>
            <input
              type="time"
              id="time-input"
              name="time_str"
              class="editor-input"
              step="60"
            >
          </div>

          <div class="editor-row">
            <label for="place-input">장소 (선택)</label>
            <input
              type="text"
              id="place-input"
              name="place"
              class="editor-input"
              placeholder="예: 집, 회사, 스터디카페"
            >
          </div>

          <div class="editor-row">
            <label for="memo-input">메모 (선택)</label>
            <textarea
              id="memo-input"
              name="memo"
              class="editor-textarea"
            ></textarea>
          </div>

          <div class="editor-bottom">
            <!-- 작성 폼 초기화 -->
            <button type="button" class="btn-round" id="btn-new">
              새 일정
            </button>
            <!-- 저장 (작성/수정 둘 다 이 버튼 사용) -->
            <button type="submit" class="btn-round" id="btn-save">
              저장
            </button>
            <!-- 삭제 (수정 모드에서만 보임) -->
            <button
              type="button"
              class="btn-round"
              id="btn-delete"
              style="display:none;"
            >
              삭제
            </button>
          </div>
        </form>

        <!-- 삭제 전용 숨김 폼: action 은 JS에서 /schedule/{id}/delete 로 세팅 -->
        <form id="schedule-delete-form" method="post" style="display:none;"></form>
      </section>
    </div>
  </div>
</div>

<script>
  (function () {
    // ===== 공통 DOM 레퍼런스 =====
    const editorForm   = document.getElementById("schedule-editor-form");
    const deleteForm   = document.getElementById("schedule-delete-form");
    const idHidden     = document.getElementById("schedule-id-hidden");
    const dateInput    = document.getElementById("date-input");
    const timeInput    = document.getElementById("time-input");
    const titleInput   = document.getElementById("title-input");
    const placeInput   = document.getElementById("place-input");
    const memoInput    = document.getElementById("memo-input");

    const editorTitle  = document.getElementById("editor-title");
    const modeBadge    = document.getElementById("editor-mode-badge");
    const btnNew       = document.getElementById("btn-new");
    const btnDelete    = document.getElementById("btn-delete");

    const listButtons  = document.querySelectorAll(".schedule-item");

    let currentId = null;

    // 오늘 날짜를 YYYY-MM-DD 문자열로 반환
    function todayStr() {
      const d = new Date();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return d.getFullYear() + "-" + m + "-" + day;
    }

    // ===== 모드 전환: 새 일정 작성 =====
    function setCreateMode(selectedDate) {
      currentId = null;
      idHidden.value = "";
      editorTitle.textContent = "일정 작성";
      modeBadge.textContent = "새 일정";

      titleInput.value = "";
      dateInput.value  = selectedDate || todayStr();
      timeInput.value  = "";
      placeInput.value = "";
      memoInput.value  = "";

      // 새 일정은 /schedule/new 로 전송
      editorForm.action = "/schedule/new";
      deleteForm.action = "";
      btnDelete.style.display = "none";
    }

    // ===== 모드 전환: 일정 수정 =====
    function setEditMode(data) {
      currentId = data.id;
      idHidden.value = data.id || "";

      editorTitle.textContent = "일정 수정";
      modeBadge.textContent   = "수정 모드";

      titleInput.value = data.title || "";
      dateInput.value  = data.date || todayStr();

      // time_str 또는 time 필드 중 있는 것을 사용
      if (data.time_str !== undefined) {
        timeInput.value = data.time_str || "";
      } else if (data.time !== undefined) {
        timeInput.value = data.time || "";
      } else {
        timeInput.value = "";
      }

      placeInput.value = data.place || "";
      memoInput.value  = data.memo || "";

      // 수정 시에는 /schedule/{id}/update 로 전송
      editorForm.action = "/schedule/" + data.id + "/update";
      // 삭제 폼도 /schedule/{id}/delete 로 설정
      deleteForm.action = "/schedule/" + data.id + "/delete";
      btnDelete.style.display = "inline-block";
    }

    // 페이지 로딩 시 기본은 새 일정 모드
    setCreateMode();

    // "새 일정" 버튼 → 폼만 초기화(날짜는 현재 선택/오늘 유지)
    btnNew.addEventListener("click", function () {
      setCreateMode(dateInput.value || todayStr());
    });

    // 목록에서 일정 클릭 → 해당 일정 정보를 가져와 수정 모드로 변경
    listButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        const id = btn.dataset.id;
        if (!id) return;

        fetch("/api/schedule/" + id)
          .then(function (res) { return res.json(); })
          .then(function (data) {
            setEditMode(data);
            // 달력 쪽 선택 날짜도 같이 맞춰주기
            if (data.date) {
              setSelectedDate(data.date);
            }
          })
          .catch(function (err) {
            console.error(err);
            alert("일정을 불러오지 못했습니다.");
          });
      });
    });

    // 저장 버튼 클릭 시 확인 창
    editorForm.addEventListener("submit", function (e) {
      const msg = currentId
        ? "이 일정 내용을 수정할까요?"
        : "새 일정을 저장할까요?";
      if (!window.confirm(msg)) {
        e.preventDefault();
      }
    });

    // 삭제 버튼 클릭 시 → 숨은 deleteForm을 사용해 삭제 요청
    btnDelete.addEventListener("click", function () {
      if (!currentId) return;
      if (!window.confirm("정말 삭제할까요?")) return;
      deleteForm.submit();
    });

    // ===== 달력 렌더링 관련 =====
    const calBody    = document.getElementById("calendar-body");
    const calPrev    = document.getElementById("cal-prev");
    const calNext    = document.getElementById("cal-next");
    const yearSelect = document.getElementById("year-select");
    const monthSelect= document.getElementById("month-select");

    // 일정이 있는 날짜 목록을 Set 으로 관리 (YYYY-MM-DD)
    const scheduleDateSet = new Set(
      Array.from(listButtons).map(function (btn) {
        return btn.dataset.date;
      })
    );

    // 양력 공휴일 목록 (월-일 기준)
    const SOLAR_HOLIDAYS = {
      "01-01": "신정",
      "03-01": "삼일절",
      "05-05": "어린이날",
      "06-06": "현충일",
      "08-15": "광복절",
      "10-03": "개천절",
      "10-09": "한글날",
      "12-25": "성탄절",
    };

    const today = new Date();
    let currentYear  = today.getFullYear();
    let currentMonth = today.getMonth(); // 0~11
    let selectedDate = todayStr();

    // Date 객체 → YYYY-MM-DD
    function formatDate(d) {
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return d.getFullYear() + "-" + m + "-" + day;
    }

    // 해당 날짜가 공휴일이면 이름을 반환, 아니면 null
    function getSolarHolidayName(d) {
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const key = mm + "-" + dd;
      return SOLAR_HOLIDAYS[key] || null;
    }

    // 날짜 선택 시 내부 상태 + 입력 폼 동기화
    function setSelectedDate(dateStr) {
      selectedDate = dateStr;
      dateInput.value = dateStr;
      renderCalendar();
    }

    // 연도 select 채우기 (현재 연도를 중심으로 ±50년)
    function fillYearOptions() {
      const baseYear = today.getFullYear();
      const from = baseYear - 50;
      const to   = baseYear + 50;

      yearSelect.innerHTML = "";
      for (let y = from; y <= to; y++) {
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = y + "년";
        yearSelect.appendChild(opt);
      }
    }

    // select 박스 값과 내부 year/month 동기화
    function syncSelects() {
      yearSelect.value = String(currentYear);
      monthSelect.value = String(currentMonth);
    }

    // 달력 다시 그리기
    function renderCalendar() {
      calBody.innerHTML = "";
      syncSelects();

      const first = new Date(currentYear, currentMonth, 1);
      let day = 1 - first.getDay(); // 첫 주의 시작 날짜(일요일 기준) 계산

      for (let week = 0; week < 6; week++) {
        const tr = document.createElement("tr");

        for (let dow = 0; dow < 7; dow++, day++) {
          const d = new Date(currentYear, currentMonth, day);
          const td = document.createElement("td");

          const dateStr = formatDate(d);
          td.textContent = d.getDate();
          td.dataset.date = dateStr;

          // 이번 달이 아닌 날짜 흐리게 표시
          if (d.getMonth() !== currentMonth) {
            td.classList.add("cal-out");
          }

          // 오늘 표시
          if (dateStr === formatDate(today)) {
            td.classList.add("cal-today");
          }

          // 선택된 날짜 강조
          if (dateStr === selectedDate) {
            td.classList.add("cal-selected");
          }

          // 이 날짜에 일정이 있으면 점 표시 클래스 추가
          if (scheduleDateSet.has(dateStr)) {
            td.classList.add("cal-has-schedule");
          }

          // 공휴일이면 색 + title 툴팁
          const holidayName = getSolarHolidayName(d);
          if (holidayName) {
            td.classList.add("cal-holiday");
            td.title = holidayName;
          }

          // 날짜 클릭 시 선택 날짜 변경
          td.addEventListener("click", function () {
            setSelectedDate(td.dataset.date);
          });

          tr.appendChild(td);
        }

        calBody.appendChild(tr);
      }
    }

    // 이전 달 버튼
    calPrev.addEventListener("click", function () {
      currentMonth -= 1;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear -= 1;
      }
      renderCalendar();
    });

    // 다음 달 버튼
    calNext.addEventListener("click", function () {
      currentMonth += 1;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear += 1;
      }
      renderCalendar();
    });

    // 연도 셀렉트가 바뀌면 해당 연도로 이동
    yearSelect.addEventListener("change", function () {
      currentYear = parseInt(yearSelect.value, 10);
      renderCalendar();
    });

    // 월 셀렉트가 바뀌면 해당 월로 이동
    monthSelect.addEventListener("change", function () {
      currentMonth = parseInt(monthSelect.value, 10);
      renderCalendar();
    });

    // 초기 설정 + 렌더링
    fillYearOptions();
    setSelectedDate(todayStr());
    renderCalendar();
  })();
</script>
{% endblock %}
